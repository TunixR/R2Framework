# Pre-commit Setup

This repository uses [pre-commit](https://pre-commit.com/) to ensure code quality, security, and testing standards before commits are pushed.

## What's Included

The pre-commit configuration checks for:

1. **Ruff Linting** - Fast Python linter that checks for code errors and style issues
2. **Ruff Formatting** - Automatic code formatting to maintain consistent style
3. **Bandit** - Security vulnerability scanner for Python code
4. **Basedpyright** - Type checking to catch type-related errors
5. **Unit Tests** - Runs unit tests (not integration tests) to ensure code correctness

## Installation

Pre-commit hooks are automatically installed when you make your first commit. However, you can manually install them:

```bash
# Install pre-commit if not already installed
pip install pre-commit

# Install the pre-commit hooks
pre-commit install
```

## Usage

Once installed, the hooks will run automatically on every commit. If any hook fails, the commit will be blocked until the issues are resolved.

### Running Manually

You can run all hooks manually on all files:

```bash
pre-commit run --all-files
```

Or run a specific hook:

```bash
pre-commit run ruff --all-files
pre-commit run basedpyright --all-files
pre-commit run pytest-unit --all-files
```

### Bypassing Hooks (Not Recommended)

In rare cases where you need to bypass the hooks (e.g., work in progress commit), you can use:

```bash
git commit --no-verify
```

**Note:** This should be avoided as it defeats the purpose of the quality checks.

## Configuration

### Ruff
Configuration can be found in `pyproject.toml` under `[tool.ruff]` section (if present) or in the `.pre-commit-config.yaml` file.

### Basedpyright
Configuration is in `pyproject.toml` under `[tool.basedpyright]`. The current configuration:
- Uses "basic" type checking mode
- Disables warnings for unknown types (to reduce noise)
- Reports actual errors like call issues and attribute access problems

### Bandit
Configuration is in `pyproject.toml` under `[tool.bandit]`. Currently skips:
- B101: Assert statements (common in tests)
- B307: Use of `eval()` (pre-existing in codebase)
- B113: Requests without timeout (pre-existing in codebase)

### Unit Tests
Only runs tests in the `tests/unit` directory, excluding integration tests to keep commits fast.

## Updating Hooks

To update the pre-commit hooks to their latest versions:

```bash
pre-commit autoupdate
```

## Troubleshooting

### Hook installation fails
If hooks fail to install, try:
```bash
pre-commit clean
pre-commit install
```

### Hooks run slowly
The first run will be slow as dependencies are installed. Subsequent runs will be much faster.

### Type checking errors
If you encounter persistent type checking errors that you believe are false positives, you can:
1. Add a `# pyright: ignore[ruleName]` comment (preferred)
2. Adjust the basedpyright configuration in `pyproject.toml`

### Test failures
If unit tests fail, investigate the specific test that's failing. The pre-commit hook runs all unit tests, so any failing test will block the commit.

## Benefits

- **Catch errors early**: Issues are caught before code review, saving time
- **Consistent code style**: Automatic formatting ensures consistency across the codebase
- **Security**: Bandit helps identify potential security vulnerabilities
- **Type safety**: Basedpyright catches type-related bugs before runtime
- **Reliability**: Unit tests ensure changes don't break existing functionality
